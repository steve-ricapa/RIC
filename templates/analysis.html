{% extends "base.html" %}

{% block title %}Análisis - {{ analysis.original_filename }}{% endblock %}

{% block content %}
<div class="container my-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Inicio</a></li>
                    <li class="breadcrumb-item active">Análisis</li>
                </ol>
            </nav>
            
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <!-- Subject and Educational Context -->
                    {% if analysis.subject or analysis.grade_level or analysis.lesson_topic %}
                    <div class="educational-context-header mb-3">
                        <div class="d-flex flex-wrap gap-2 mb-2">
                            {% if analysis.subject %}
                            <span class="badge bg-subject-{{ analysis.subject|replace(' ', '_')|replace('/', '_')|lower }} fs-6">
                                <i data-feather="book" class="me-1"></i>
                                {{ analysis.subject }}
                            </span>
                            {% endif %}
                            {% if analysis.grade_level %}
                            <span class="badge bg-grade fs-6">
                                <i data-feather="users" class="me-1"></i>
                                {{ analysis.grade_level }}
                            </span>
                            {% endif %}
                        </div>
                        {% if analysis.lesson_topic %}
                        <h1 class="h2 mb-1 lesson-topic">{{ analysis.lesson_topic }}</h1>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    {% if not analysis.lesson_topic %}
                    <h1 class="h3 mb-1">{{ analysis.original_filename }}</h1>
                    {% endif %}
                    
                    <p class="text-soft mb-1">
                        <i data-feather="calendar" class="me-1"></i>
                        Subido el {{ analysis.upload_timestamp.strftime('%d/%m/%Y a las %H:%M') }}
                    </p>
                    
                    {% if analysis.additional_context %}
                    <p class="text-secondary small mb-2">
                        <i data-feather="info" class="me-1"></i>
                        {{ analysis.additional_context }}
                    </p>
                    {% endif %}
                </div>
                <div class="status-badge">
                    <span class="badge status-badge-{% if analysis.status == 'completed' %}success{% elif analysis.status == 'error' %}danger{% elif analysis.status == 'processing' %}warning{% else %}secondary{% endif %} fs-6">
                        {% if analysis.status == 'completed' %}
                            <i data-feather="check-circle" class="me-1"></i>
                            Análisis Completado
                        {% elif analysis.status == 'error' %}
                            <i data-feather="alert-circle" class="me-1"></i>
                            Error en el Análisis
                        {% elif analysis.status == 'processing' %}
                            <i data-feather="clock" class="me-1"></i>
                            Procesando...
                        {% else %}
                            <i data-feather="upload" class="me-1"></i>
                            Subido
                        {% endif %}
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Processing State -->
    {% if analysis.status == 'processing' %}
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body text-center py-5">
                    <div class="spinner-border text-primary mb-3" role="status"></div>
                    <h5>Analizando tu clase...</h5>
                    <p class="text-secondary">
                        Estamos procesando tu audio con IA avanzada. Esto puede tomar unos minutos.
                    </p>
                    <div class="progress-steps mt-4">
                        <div class="step completed">
                            <i data-feather="upload"></i>
                            <span>Subido</span>
                        </div>
                        <div class="step processing">
                            <i data-feather="mic"></i>
                            <span>Transcribiendo</span>
                        </div>
                        <div class="step">
                            <i data-feather="bar-chart-2"></i>
                            <span>Analizando</span>
                        </div>
                        <div class="step">
                            <i data-feather="brain"></i>
                            <span>Generando Feedback</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Error State -->
    {% if analysis.status == 'error' %}
    <div class="row">
        <div class="col-12">
            <div class="alert alert-danger">
                <h5><i data-feather="alert-circle" class="me-2"></i>Error en el Análisis</h5>
                <p class="mb-0 text-secondary">{{ analysis.error_message or 'Ocurrió un error inesperado durante el análisis.' }}</p>
                <hr>
                <a href="{{ url_for('index') }}" class="btn btn-soft-primary">
                    <i data-feather="refresh-cw" class="me-2"></i>
                    Intentar Nuevamente
                </a>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Completed Analysis Results -->
    {% if analysis.status == 'completed' %}
    <div id="analysisResults">
        <!-- Loading placeholder -->
        <div class="text-center py-5">
            <div class="spinner-border text-primary"></div>
            <p class="mt-2">Cargando resultados...</p>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
{% if analysis.status == 'completed' %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadAnalysisResults();
});

async function loadAnalysisResults() {
    try {
        const response = await fetch(`/api/analysis/{{ analysis.id }}/results`);
        const data = await response.json();
        
        if (response.ok) {
            displayResults(data);
        } else {
            showError('Error al cargar los resultados: ' + data.error);
        }
    } catch (error) {
        showError('Error de conexión: ' + error.message);
    }
}

function displayResults(data) {
    const container = document.getElementById('analysisResults');
    const feedback = data.feedback;
    const transcription = data.transcription;
    const prosody = data.prosody;
    
    container.innerHTML = `
        <!-- Overall Score -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card bg-gradient-primary text-white">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h4 class="card-title mb-2">Puntuación General</h4>
                                <p class="card-text opacity-75">${feedback.summary}</p>
                            </div>
                            <div class="col-md-4 text-end">
                                <div class="score-circle">
                                    <canvas id="scoreChart" width="120" height="120"></canvas>
                                    <div class="score-text">
                                        <span class="score-number">${feedback.overall_score}</span>
                                        <span class="score-label">/100</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Key Metrics -->
        <div class="row mb-4">
            <div class="col-md-2">
                <div class="metric-card">
                    <div class="metric-icon">
                        <i data-feather="clock"></i>
                    </div>
                    <div class="metric-value">${transcription.wpm}</div>
                    <div class="metric-label">Palabras por minuto</div>
                    <div class="metric-status ${getSpeedStatus(transcription.wpm)}">${getSpeedText(transcription.wpm)}</div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="metric-card">
                    <div class="metric-icon">
                        <i data-feather="pause"></i>
                    </div>
                    <div class="metric-value">${transcription.pauses.count}</div>
                    <div class="metric-label">Pausas efectivas</div>
                    <div class="metric-status ${getPauseStatus(feedback.key_metrics.pause_effectiveness)}">${feedback.key_metrics.pause_effectiveness}</div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="metric-card">
                    <div class="metric-icon">
                        <i data-feather="volume-2"></i>
                    </div>
                    <div class="metric-value">${Math.round(prosody.f0_mean_hz)}</div>
                    <div class="metric-label">Tono promedio (Hz)</div>
                    <div class="metric-status ${getConfidenceStatus(feedback.key_metrics.vocal_confidence)}">${feedback.key_metrics.vocal_confidence}</div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="metric-card">
                    <div class="metric-icon">
                        <i data-feather="filter"></i>
                    </div>
                    <div class="metric-value">${transcription.filler_count}</div>
                    <div class="metric-label">Muletillas</div>
                    <div class="metric-status ${getFillerStatus(feedback.key_metrics.filler_word_frequency)}">${feedback.key_metrics.filler_word_frequency}</div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="metric-card">
                    <div class="metric-icon">
                        <i data-feather="graduation-cap"></i>
                    </div>
                    <div class="metric-value">${feedback.detailed_analysis.grade_level_appropriateness.score}</div>
                    <div class="metric-label">Adecuación al Grado</div>
                    <div class="metric-status ${getGradeStatus(feedback.key_metrics.grade_appropriateness)}">${feedback.key_metrics.grade_appropriateness}</div>
                </div>
            </div>
        </div>

        <!-- Detailed Analysis -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header">
                        <h5><i data-feather="mic" class="me-2"></i>Entrega y Claridad</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <div class="progress flex-grow-1 me-3">
                                <div class="progress-bar" style="width: ${feedback.detailed_analysis.speech_delivery.score}%"></div>
                            </div>
                            <span class="fw-bold">${feedback.detailed_analysis.speech_delivery.score}/100</span>
                        </div>
                        <p class="text-muted small">${feedback.detailed_analysis.speech_delivery.feedback}</p>
                        <div class="recommendations">
                            <strong>Recomendaciones:</strong>
                            <ul class="small mt-2">
                                ${feedback.detailed_analysis.speech_delivery.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header">
                        <h5><i data-feather="activity" class="me-2"></i>Ritmo y Engagement</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <div class="progress flex-grow-1 me-3">
                                <div class="progress-bar bg-success" style="width: ${feedback.detailed_analysis.engagement_pace.score}%"></div>
                            </div>
                            <span class="fw-bold">${feedback.detailed_analysis.engagement_pace.score}/100</span>
                        </div>
                        <p class="text-muted small">${feedback.detailed_analysis.engagement_pace.feedback}</p>
                        <div class="recommendations">
                            <strong>Recomendaciones:</strong>
                            <ul class="small mt-2">
                                ${feedback.detailed_analysis.engagement_pace.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header">
                        <h5><i data-feather="trending-up" class="me-2"></i>Variedad Vocal</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <div class="progress flex-grow-1 me-3">
                                <div class="progress-bar bg-warning" style="width: ${feedback.detailed_analysis.vocal_variety.score}%"></div>
                            </div>
                            <span class="fw-bold">${feedback.detailed_analysis.vocal_variety.score}/100</span>
                        </div>
                        <p class="text-muted small">${feedback.detailed_analysis.vocal_variety.feedback}</p>
                        <div class="recommendations">
                            <strong>Recomendaciones:</strong>
                            <ul class="small mt-2">
                                ${feedback.detailed_analysis.vocal_variety.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header">
                        <h5><i data-feather="user-check" class="me-2"></i>Comunicación Profesional</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <div class="progress flex-grow-1 me-3">
                                <div class="progress-bar bg-info" style="width: ${feedback.detailed_analysis.professional_communication.score}%"></div>
                            </div>
                            <span class="fw-bold">${feedback.detailed_analysis.professional_communication.score}/100</span>
                        </div>
                        <p class="text-muted small">${feedback.detailed_analysis.professional_communication.feedback}</p>
                        <div class="recommendations">
                            <strong>Recomendaciones:</strong>
                            <ul class="small mt-2">
                                ${feedback.detailed_analysis.professional_communication.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Grade Level Appropriateness -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-success">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i data-feather="graduation-cap" class="me-2"></i>Adecuación al Nivel Educativo</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <div class="progress flex-grow-1 me-3" style="height: 12px;">
                                <div class="progress-bar bg-success" style="width: ${feedback.detailed_analysis.grade_level_appropriateness.score}%"></div>
                            </div>
                            <span class="fw-bold fs-5">${feedback.detailed_analysis.grade_level_appropriateness.score}/100</span>
                        </div>
                        <p class="mb-3">${feedback.detailed_analysis.grade_level_appropriateness.feedback}</p>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="recommendations">
                                    <strong>Recomendaciones Específicas:</strong>
                                    <ul class="mt-2">
                                        ${feedback.detailed_analysis.grade_level_appropriateness.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                                    </ul>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="grade-tips">
                                    <strong>Consejos para este Grado:</strong>
                                    <ul class="mt-2">
                                        ${feedback.grade_specific_tips ? feedback.grade_specific_tips.map(tip => `<li>${tip}</li>`).join('') : '<li>No hay consejos específicos disponibles</li>'}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Strengths and Areas for Improvement -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card h-100 border-success">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i data-feather="check-circle" class="me-2"></i>Fortalezas</h5>
                    </div>
                    <div class="card-body">
                        <ul class="list-unstyled mb-0">
                            ${feedback.strengths.map(strength => `
                                <li class="mb-2">
                                    <i data-feather="check" class="text-success me-2"></i>
                                    ${strength}
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card h-100 border-warning">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0"><i data-feather="target" class="me-2"></i>Áreas de Mejora</h5>
                    </div>
                    <div class="card-body">
                        <ul class="list-unstyled mb-0">
                            ${feedback.areas_for_improvement.map(area => `
                                <li class="mb-2">
                                    <i data-feather="arrow-right" class="text-warning me-2"></i>
                                    ${area}
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Plan -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-primary">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i data-feather="list" class="me-2"></i>Plan de Acción</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-3">Pasos concretos para mejorar tu técnica de enseñanza:</p>
                        <ol>
                            ${feedback.action_plan.map(action => `<li class="mb-2">${action}</li>`).join('')}
                        </ol>
                    </div>
                </div>
            </div>
        </div>

        <!-- Transcription -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i data-feather="file-text" class="me-2"></i>Transcripción</h5>
                    </div>
                    <div class="card-body">
                        <div class="transcription-text">
                            ${transcription.text}
                        </div>
                        <div class="mt-3 text-muted small">
                            <strong>Estadísticas:</strong> 
                            ${transcription.word_count} palabras | 
                            ${transcription.wpm} PPM | 
                            ${transcription.filler_count} muletillas (${transcription.filler_rate}%)
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Update feather icons
    feather.replace();
    
    // Create score chart
    createScoreChart(feedback.overall_score);
}

function createScoreChart(score) {
    const ctx = document.getElementById('scoreChart').getContext('2d');
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            datasets: [{
                data: [score, 100 - score],
                backgroundColor: ['#ffffff', 'rgba(255,255,255,0.2)'],
                borderWidth: 0
            }]
        },
        options: {
            cutout: '80%',
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
}

function getSpeedStatus(wpm) {
    if (wpm < 120) return 'status-slow';
    if (wpm > 160) return 'status-fast';
    return 'status-optimal';
}

function getSpeedText(wpm) {
    if (wpm < 120) return 'Lento';
    if (wpm > 160) return 'Rápido';
    return 'Óptimo';
}

function getPauseStatus(effectiveness) {
    const statusMap = {
        'excellent': 'status-excellent',
        'good': 'status-good',
        'fair': 'status-fair',
        'poor': 'status-poor'
    };
    return statusMap[effectiveness] || 'status-fair';
}

function getConfidenceStatus(confidence) {
    const statusMap = {
        'high': 'status-excellent',
        'moderate': 'status-good',
        'low': 'status-poor'
    };
    return statusMap[confidence] || 'status-fair';
}

function getFillerStatus(frequency) {
    const statusMap = {
        'low': 'status-excellent',
        'moderate': 'status-good',
        'high': 'status-poor'
    };
    return statusMap[frequency] || 'status-fair';
}

function getGradeStatus(appropriateness) {
    const statusMap = {
        'adecuado': 'status-excellent',
        'simple': 'status-good',
        'complejo': 'status-good',
        'muy_simple': 'status-poor',
        'muy_complejo': 'status-poor'
    };
    return statusMap[appropriateness] || 'status-fair';
}

function showError(message) {
    document.getElementById('analysisResults').innerHTML = `
        <div class="alert alert-danger">
            <i data-feather="alert-circle" class="me-2"></i>
            ${message}
        </div>
    `;
    feather.replace();
}
</script>
{% elif analysis.status == 'processing' %}
<script>
// Auto-refresh for processing status
setTimeout(function() {
    location.reload();
}, 10000); // Refresh every 10 seconds
</script>
{% endif %}
{% endblock %}
